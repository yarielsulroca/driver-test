<div class="container">
  <div class="header-section">
    <h2>Gestión de Conductores</h2>
    <div class="header-buttons">
      <button class="btn btn-primary" routerLink="/conductores/crear" title="Crear nuevo conductor">
        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
        </svg>
        Nuevo Conductor
      </button>
      <button class="btn btn-secondary" (click)="irAInicio()" title="Volver al inicio">
        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
        </svg>
        Ir a Inicio
      </button>
    </div>
  </div>
  
  <!-- Filtros y Búsqueda -->
  <div class="filters-section">
    <div class="search-filters">
      <div class="search-input">
        <svg class="search-icon" width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
        </svg>
        <input 
          type="text" 
          placeholder="Buscar por nombre o DNI..." 
          [(ngModel)]="searchTerm"
          (input)="onSearchChange()"
          class="search-field">
      </div>
      
      <div class="filter-controls">
        <select [(ngModel)]="estadoFilter" (change)="onFilterChange()" class="filter-select" title="Filtrar por estado del conductor">
          <option value="">Todos los estados</option>
          <option value="b">Aprobados</option>
          <option value="p">Pendientes</option>
        </select>
        
        <button class="btn btn-outline" (click)="clearFilters()" title="Limpiar filtros">
          <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
          Limpiar
        </button>
      </div>
    </div>
    
    <div class="results-info" *ngIf="mostrarContadorResultados">
      <span class="results-count">
        Mostrando {{ conductoresFiltrados.length }} de {{ conductores.length }} conductores
      </span>
    </div>
  </div>
  
  <div *ngIf="loading" class="loading">
    <div class="spinner"></div>
    Cargando conductores...
  </div>
  
  <div *ngIf="error" class="error">
    <strong>Error:</strong> {{ error }}
  </div>
  
  <div *ngIf="!loading && !error && datosListos" class="content">
    <div class="summary">
      <p><strong>Total de conductores:</strong> {{ conductores.length }}</p>
    </div>
    
    <div class="table-container">
      <table class="conductores-table">
        <thead>
          <tr>
            <th>Nombre del Conductor</th>
            <th>DNI</th>
            <th>Estado</th>
            <th>Categorías Aprobadas</th>
            <th>Categorías Pendientes</th>
            <th>Intentos por Categoría</th>
            <th>Puntaje Exámenes Aprobados</th>
            <th>Puntaje Examen Reprobado</th>
            <th>Fechas</th>
            <th>Habilitar Examen</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let conductor of conductoresFiltrados; trackBy: trackByConductorId">
            <!-- Nombre del Conductor -->
            <td>
              <div class="conductor-name">
                <strong>{{ conductor.nombre }} {{ conductor.apellido }}</strong>
              </div>
            </td>
            
            <!-- DNI -->
            <td>{{ conductor.dni }}</td>
            
            <!-- Estado -->
            <td>
              <span [class]="conductor.estado === 'b' ? 'estado-bueno' : 'estado-pendiente'">
                {{ conductor.estado === 'b' ? 'Aprobado' : 'Pendiente' }}
              </span>
            </td>
            
            <!-- Categorías Aprobadas -->
            <td>
              <div class="categories-approved">
                <div *ngIf="(conductor.categorias_aprobadas || []).length > 0; else noApprovedCategories">
                  <div *ngFor="let categoria of conductor.categorias_aprobadas" class="category-item approved">
                    <div class="category-name">{{ categoria.categoria_codigo || categoria.categoria || 'N/A' }}</div>
                    <div class="category-score">{{ categoria.puntaje_obtenido || 0 }}%</div>
                  </div>
                </div>
                <ng-template #noApprovedCategories>
                  <div class="no-categories">Sin categorías aprobadas</div>
                </ng-template>
              </div>
            </td>
            
            <!-- Categorías Pendientes -->
            <td>
              <div class="categories-pending">
                <div *ngIf="(conductor.categorias_pendientes || []).length > 0; else noPendingCategories">
                  <div *ngFor="let categoria of conductor.categorias_pendientes" class="category-item pending">
                    <div class="category-name">{{ categoria.categoria_codigo || categoria.categoria_nombre || 'N/A' }}</div>
                    <div class="category-state" [class]="'state-' + categoria.estado.toLowerCase()">
                      {{ categoria.estado }}
                    </div>
                  </div>
                </div>
                <ng-template #noPendingCategories>
                  <div class="no-categories">Sin categorías pendientes</div>
                </ng-template>
              </div>
            </td>
            
            <!-- Intentos por Categoría -->
            <td>
              <div class="attempts-info">
                <div *ngIf="(conductor.categorias_pendientes || []).length > 0; else noAttempts">
                  <div *ngFor="let categoria of conductor.categorias_pendientes" class="attempt-item">
                    <strong>{{ categoria.categoria_codigo || categoria.categoria_nombre || 'N/A' }}:</strong>
                    {{ categoria.intentos_realizados || 0 }}/{{ categoria.intentos_maximos || 0 }} intentos
                  </div>
                </div>
                <ng-template #noAttempts>
                  <div class="no-attempts">Sin intentos</div>
                </ng-template>
              </div>
            </td>
            
            <!-- Puntaje de Exámenes Aprobados -->
            <td>
              <div class="exam-values">
                <div *ngIf="(conductor.categorias_aprobadas || []).length > 0; else noValues">
                  <div *ngFor="let categoria of conductor.categorias_aprobadas" class="value-item">
                    <strong>{{ categoria.categoria_codigo || categoria.categoria || 'N/A' }}:</strong>
                    {{ categoria.puntaje_obtenido || 0 }}%
                  </div>
                </div>
                <ng-template #noValues>
                  <div class="no-values">Sin exámenes aprobados</div>
                </ng-template>
              </div>
            </td>
            
            <!-- Puntaje Examen Reprobado -->
            <td>
              <div class="exam-failed-values">
                <div *ngIf="getValorExamenReprobado(conductor); else noFailedValues">
                  <div class="failed-value-item">
                    <strong>{{ getValorExamenReprobado(conductor).categoria }}:</strong>
                    {{ getValorExamenReprobado(conductor).puntaje }}%
                  </div>
                </div>
                <ng-template #noFailedValues>
                  <div class="no-failed-values">Sin reprobados</div>
                </ng-template>
              </div>
            </td>
            
            <!-- Fechas -->
            <td>
              <div class="dates-info">
                <div *ngIf="(conductor.categorias_pendientes || []).length > 0; else noDates">
                  <div *ngFor="let categoria of conductor.categorias_pendientes" class="date-item">
                    <div *ngIf="categoria.fecha_ultimo_intento">
                      <strong>Último:</strong> {{ categoria.fecha_ultimo_intento | date:'dd/MM/yyyy' }}
                    </div>
                    <div *ngIf="categoria.fecha_asignacion">
                      <strong>Asignado:</strong> {{ categoria.fecha_asignacion | date:'dd/MM/yyyy' }}
                    </div>
                  </div>
                </div>
                <ng-template #noDates>
                  <div class="no-dates">Sin fechas</div>
                </ng-template>
              </div>
            </td>
            
            <!-- Habilitar Examen -->
            <td>
              <button class="btn btn-success btn-sm" 
                      (click)="habilitarExamen(conductor)"
                      [disabled]="!puedeHabilitarExamen(conductor)"
                      [title]="getTooltipHabilitarExamen(conductor)">
                Habilitar Examen
              </button>
              <div *ngIf="!puedeHabilitarExamen(conductor)" class="motivo-deshabilitado">
                {{ getMotivoDeshabilitado(conductor) }}
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
  
  <!-- Selector de Exámenes -->
  <app-examen-selector 
    [isOpen]="showExamenSelector"
    [conductor]="selectedConductor"
    (close)="closeExamenSelector()"
    (examenSeleccionado)="onExamenSeleccionado($event)">
  </app-examen-selector>
  
  <!-- Modal de Edición de Conductor -->
  <app-conductor-edit-modal
    [isOpen]="showConductorEditModal"
    [conductor]="selectedConductor"
    (close)="closeConductorEditModal()"
    (save)="onConductorSaved($event)">
  </app-conductor-edit-modal>
</div>
